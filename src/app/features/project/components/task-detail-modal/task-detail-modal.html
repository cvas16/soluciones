<div *ngIf="isVisible" class="modal-backdrop" (click)="onBackdropClick($event)">
  <div class="modal-dialog fixed-top" (click)="$event.stopPropagation()">
    <div class="modal-content-wrapper" *ngIf="task">
      <div class="modal-header">
        <div class="breadcrumb">
          <div class="project-icon"></div>
          <span>TaskFlow</span> /
          <a href="javascript:void(0)" class="task-id-link">TF-{{ task.id }}</a>
        </div>
        <button class="close-btn" (click)="close()">√ó</button>
      </div>

      <div class="modal-body-layout">
        <div class="main-content">
          <input
            type="text"
            [(ngModel)]="editedTask.title"
            class="title-input"
            placeholder="Resumen de la tarea"
          />

          <div class="section-group">
            <h5 class="section-label">Descripci√≥n</h5>
            <textarea
              [(ngModel)]="editedTask.description"
              class="description-area"
              rows="6"
              placeholder="A√±ade una descripci√≥n detallada..."
            ></textarea>
          </div>

          <div class="section-group mt-4">
            <h5 class="section-label">Archivos y Enlaces</h5>

            <div class="attachments-list">
              <div
                *ngFor="let url of editedTask.attachments; let i = index"
                class="attachment-item-wrapper"
              >
                <a [href]="url" target="_blank" class="attachment-card" title="{{ url }}">
                  <div class="attachment-thumb" [ngSwitch]="getAttachmentType(url)">
                    <img *ngSwitchCase="'image'" [src]="url" class="img-preview" />
                    <span *ngSwitchCase="'video'" style="color: #ff0000; font-size: 1.5rem">‚ñ∂</span>
                    <span *ngSwitchCase="'link'" style="color: #2563eb; font-size: 1.5rem">üîó</span>
                    <span *ngSwitchDefault style="font-size: 1.5rem">üìÑ</span>
                  </div>
                  <div class="attachment-info">
                    <span
                      class="text-truncate d-block fw-bold"
                      style="max-width: 110px; font-size: 0.8rem"
                    >
                      {{ getAttachmentName(url) }}
                    </span>
                    <span class="text-muted" style="font-size: 0.7rem">
                      {{ getAttachmentType(url) | uppercase }}
                    </span>
                  </div>
                </a>
                <button class="btn-remove-attachment" (click)="removeAttachment(i)" title="Quitar">
                  √ó
                </button>
              </div>
              <label class="attachment-card add-card" style="cursor: pointer">
                <span style="font-size: 1.5rem; color: #ccc">+</span>
                <span style="font-size: 0.8rem; color: #999">Subir</span>
                <input type="file" (change)="onFileSelected($event)" style="display: none" />
              </label>
              <div class="input-group mt-3">
                <input
                  type="text"
                  class="form-control form-control-sm"
                  placeholder="Pegar enlace (YouTube, Web...)"
                  [(ngModel)]="newAttachmentUrl"
                  (keyup.enter)="addAttachment()"
                />
                <button class="btn btn-sm btn-outline-secondary" (click)="addAttachment()">
                  A√±adir Link
                </button>
              </div>
            </div>
          </div>
          <div class="section-group mt-4">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5 class="section-label mb-0">Checklist</h5>
              <span class="text-muted small" *ngIf="subTasks.length > 0">
                {{ getProgress() }}% completado
              </span>
            </div>

            <div class="progress mb-3" style="height: 6px" *ngIf="subTasks.length > 0">
              <div
                class="progress-bar bg-success"
                role="progressbar"
                [style.width.%]="getProgress()"
              ></div>
            </div>

            <div class="subtasks-list">
              <div
                *ngFor="let sub of subTasks"
                class="subtask-item d-flex align-items-center gap-2 mb-2"
              >
                <input
                  type="checkbox"
                  class="form-check-input mt-0"
                  [checked]="sub.completed"
                  (change)="toggleSubTask(sub)"
                  style="cursor: pointer"
                />

                <span
                  class="flex-grow-1"
                  [class.text-decoration-line-through]="sub.completed"
                  [class.text-muted]="sub.completed"
                >
                  {{ sub.title }}
                </span>

                <button class="btn-remove-subtask" (click)="deleteSubTaskItem(sub.id)">√ó</button>
              </div>
            </div>

            <div class="mt-2">
              <input
                type="text"
                class="form-control form-control-sm"
                placeholder="A√±adir un elemento..."
                [(ngModel)]="newSubTaskTitle"
                (keyup.enter)="addSubTask()"
              />
              <div class="mt-2" *ngIf="newSubTaskTitle">
                <button class="btn btn-sm btn-primary me-2" (click)="addSubTask()">A√±adir</button>
                <button class="btn btn-sm btn-light" (click)="newSubTaskTitle = ''">
                  Cancelar
                </button>
              </div>
            </div>
          </div>
          <div class="section-group mt-5 pt-3 border-top">
            <h5 class="section-label mb-3">Actividad</h5>

            <div class="comments-list mb-4">
              <div *ngFor="let comment of comments" class="comment-item d-flex gap-3 mb-3">
                <div class="user-avatar mt-1">
                  {{ comment.authorUsername.charAt(0).toUpperCase() }}
                </div>

                <div class="comment-content w-100">
                  <div class="d-flex justify-content-between align-items-center mb-1">
                    <span class="fw-bold text-dark" style="font-size: 0.9rem">
                      {{ comment.authorUsername }}
                    </span>
                    <span class="text-muted" style="font-size: 0.75rem">
                      {{ getTimeAgo(comment.createdAt) }}
                    </span>
                  </div>

                  <div class="comment-text p-2 bg-light rounded">
                    {{ comment.text }}
                  </div>

                  <div *ngIf="currentUser?.id === comment.authorId" class="mt-1">
                    <button class="btn-link-danger" (click)="deleteComment(comment.id)">
                      Eliminar
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <div class="new-comment-area d-flex gap-3">
              <div class="user-avatar" style="background: #0052cc; color: white">
                {{ currentUser?.username?.charAt(0)?.toUpperCase() || 'YO' }}
              </div>
              <div class="w-100">
                <textarea
                  class="form-control mb-2"
                  rows="2"
                  placeholder="Escribe un comentario..."
                  [(ngModel)]="newCommentText"
                  [disabled]="isSendingComment"
                >
                </textarea>
                <button
                  class="btn btn-primary btn-sm"
                  (click)="sendComment()"
                  [disabled]="!newCommentText.trim() || isSendingComment"
                >
                  Guardar
                </button>
              </div>
            </div>
          </div>
        </div>

        <div class="sidebar">
          <div class="sidebar-section">
            <div class="sidebar-group">
              <label class="field-label">ESTADO</label>
              <select
                [(ngModel)]="editedTask.status"
                class="status-select"
                [attr.value]="editedTask.status"
              >
                <option value="Pendiente">PENDIENTE</option>
                <option value="En An√°lisis">EN AN√ÅLISIS</option>
                <option value="En Desarrollo">EN DESARROLLO</option>
                <option value="En Pruebas">EN PRUEBAS</option>
                <option value="Finalizado">FINALIZADO</option>
                <option value="Desestimado">DESESTIMADO</option>
              </select>
            </div>

            <div class="sidebar-group">
              <label class="field-label">PRIORIDAD</label>
              <select
                [(ngModel)]="editedTask.priority"
                class="form-select form-select-sm border-0 bg-transparent fw-bold ps-0"
                style="color: #172b4d"
              >
                <option value="Alta">Alta</option>
                <option value="Media">Media</option>
                <option value="Baja">Baja</option>
              </select>
            </div>
            <label class="field-label mb-2" style="border-bottom: 1px solid #eee; width: 100%"
              >BLOQUEOS</label
            >

            <div *ngIf="dependencies.length > 0" class="mb-3">
              <div
                *ngFor="let dep of dependencies"
                class="dependency-item d-flex align-items-center justify-content-between p-2 mb-1 bg-light rounded border"
              >
                <div class="d-flex flex-column" style="overflow: hidden">
                  <span
                    class="text-truncate fw-bold"
                    style="font-size: 0.8rem"
                    title="{{ dep.blockerTaskTitle }}"
                  >
                    {{ dep.blockerTaskTitle }}
                  </span>
                  <span class="badge bg-secondary" style="font-size: 0.6rem; width: fit-content">
                    {{ dep.blockerTaskStatus }}
                  </span>
                </div>
                <button class="btn btn-sm text-danger p-0 ms-1" (click)="removeDependency(dep.id)">
                  √ó
                </button>
              </div>
            </div>

            <div class="sidebar-group">
              <label class="field-label" style="font-size: 0.7rem">A√±adir bloqueo</label>
              <div class="d-flex gap-1">
                <select class="form-select form-select-sm" [(ngModel)]="selectedBlockerId">
                  <option [ngValue]="null">Seleccionar tarea...</option>
                  <option *ngFor="let t of availableTasks" [ngValue]="t.id">
                    #{{ t.id }} {{ t.title }}
                  </option>
                </select>
                <button
                  class="btn btn-sm btn-primary"
                  (click)="addDependency()"
                  [disabled]="!selectedBlockerId"
                >
                  +
                </button>
              </div>
            </div>
          </div>
          <div class="sidebar-section">
            <label class="field-label mb-2" style="border-bottom: 1px solid #eee; width: 100%"
              >ETIQUETAS</label
            >

            <div class="d-flex flex-wrap gap-1 mb-2">
              <span
                *ngFor="let tag of editedTask.tags"
                class="badge rounded-pill d-flex align-items-center"
                [style.background-color]="tag.color + '20'"
                [style.color]="tag.color"
                [style.border]="'1px solid ' + tag.color"
              >
                {{ tag.name }}
                <span
                  class="ms-1 cursor-pointer"
                  (click)="removeTag(tag.id)"
                  style="cursor: pointer"
                  >√ó</span
                >
              </span>
            </div>

            <div class="dropdown">
              <button
                class="btn btn-sm btn-outline-secondary w-100 text-start d-flex justify-content-between align-items-center"
                type="button"
                (click)="showTagInput = !showTagInput"
              >
                <span>+ A√±adir etiqueta</span>
              </button>

              <div
                class="card p-2 mt-1 shadow-sm"
                *ngIf="showTagInput"
                style="position: absolute; z-index: 1000; width: 100%"
              >
                <div class="mb-2" style="max-height: 100px; overflow-y: auto">
                  <div
                    *ngFor="let tag of projectTags"
                    class="p-1 cursor-pointer hover-bg"
                    (click)="addTagToTask(tag)"
                  >
                    <span class="badge" [style.background-color]="tag.color">{{ tag.name }}</span>
                  </div>
                </div>

                <hr class="my-1" />

                <div class="d-flex gap-1 mb-1">
                  <input
                    type="color"
                    class="form-control form-control-color form-control-sm"
                    [(ngModel)]="newTagColor"
                    title="Color"
                  />
                  <input
                    type="text"
                    class="form-control form-control-sm"
                    placeholder="Nueva..."
                    [(ngModel)]="newTagName"
                  />
                </div>
                <button class="btn btn-sm btn-primary w-100" (click)="createTag()">Crear</button>
              </div>
            </div>
          </div>
          <div class="sidebar-section">
            <label
              class="field-label mb-3"
              style="
                font-size: 0.85rem;
                border-bottom: 1px solid #eee;
                padding-bottom: 5px;
                width: 100%;
              "
              >PERSONAS</label
            >

            <div class="sidebar-group">
              <label class="field-label">Responsable</label>
              <div class="d-flex align-items-center gap-2">
                <div class="user-avatar">
                  {{ getAssignedUserInitial() }}
                </div>
                <select
                  class="form-select form-select-sm border-0 bg-transparent"
                  [(ngModel)]="editedTask.assignedUserId"
                  [ngModelOptions]="{ standalone: true }"
                  [disabled]="!canAssign"
                >
                  <option [ngValue]="null">Sin asignar</option>
                  <option *ngFor="let member of projectMembers" [ngValue]="member?.id ?? member">
                    {{ member?.username ?? member }}
                  </option>
                </select>
                <small *ngIf="!canAssign" class="text-muted d-block mt-1" style="font-size: 0.7rem">
                  Solo el due√±o puede asignar.
                </small>
              </div>
            </div>

            <div class="sidebar-group">
              <label class="field-label">Informador</label>
              <div class="user-row">
                <div class="user-avatar" style="background: #eae6ff; color: #403294">
                  {{
                    task.createdByUsername ? task.createdByUsername.charAt(0).toUpperCase() : '?'
                  }}
                </div>
                <span class="user-name">{{ task.createdByUsername || 'Sistema' }}</span>
              </div>
            </div>
          </div>

          <div class="sidebar-section">
            <label
              class="field-label mb-3"
              style="
                font-size: 0.85rem;
                border-bottom: 1px solid #eee;
                padding-bottom: 5px;
                width: 100%;
              "
              >FECHAS</label
            >
            <div class="sidebar-group">
              <label class="field-label">Creado</label>
              <span class="date-text">{{ getTimeAgo(task.createdAt) }}</span>
            </div>
            <div class="sidebar-group">
              <label class="field-label">Actualizado</label>
              <span class="date-text">Hace un momento</span>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-danger" (click)="deleteTask()">Eliminar</button>
        <div style="flex: 1"></div>
        <button class="btn btn-secondary" (click)="close()">Cancelar</button>
        <button class="btn btn-primary" (click)="save()" [disabled]="isSaving">
          {{ isSaving ? 'Guardando...' : 'Guardar' }}
        </button>
      </div>
    </div>
  </div>
</div>
